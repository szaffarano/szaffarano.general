---
- name: Prepare
  hosts: all
  gather_facts: false

  tasks:
    - name: Update apt cache
      ansible.builtin.raw: >-
        test -f /usr/bin/apt-get \
          && apt-get update \
        || true
      args:
        executable: /bin/bash
      register: install_output
      changed_when: true

    - name: Install bootstrap packages (Debian)
      ansible.builtin.raw: >-
        test -f /usr/bin/apt-get \
          && LANG=C apt-get update \
          && apt-get install -y python3 \
        || true
      args:
        executable: /bin/bash
      register: install_output
      changed_when:
        - "'The following additional packages' in install_output.stdout"

    - name: Install bootstrap packages (Arch)
      ansible.builtin.raw: >-
        test -f /bin/pacman \
          && pacman --noconfirm -Sy python \
        || true
      args:
        executable: /bin/bash
      register: install_output
      changed_when:
        - "install_output.stdout is search('^installing')"
